<script>
(function(){
  const API_URL='/api';
  const REFRESH_MS=10000;

  // 👉 SENHA FIXA DO MODO ADMIN
  const ADMIN_PASSWORD = 'marista@2025';

  const errBanner=document.getElementById('jsError');
  const showErr=m=>{ if(errBanner){errBanner.textContent=m||'Erro'; errBanner.classList.add('show');} };

  // horários
  const MORNING_F2M=['07:15','08:00','08:45','10:00','10:45','11:30','12:15'];
  const MORNING_IF1=['07:30','08:15','09:00','10:15','11:00','11:45','12:30'];
  const AFTERNOON_ALL=['13:30','14:15','15:00','16:15','17:00'];
  const MORNING_COMBINED=[
    {start:'07:15',label:'07:15–08:00 • Fund2/Médio'},
    {start:'07:30',label:'07:30–08:15 • Infantil/Fund1'},
    {start:'08:00',label:'08:00–08:45 • Fund2/Médio'},
    {start:'08:15',label:'08:15–09:00 • Infantil/Fund1'},
    {start:'08:45',label:'08:45–09:30 • Fund2/Médio'},
    {start:'09:00',label:'09:00–09:45 • Infantil/Fund1'},
    {intervalo:true,label:'INTERVALO'},
    {start:'10:00',label:'10:00–10:45 • Fund2/Médio'},
    {start:'10:15',label:'10:15–11:00 • Infantil/Fund1'},
    {start:'10:45',label:'10:45–11:30 • Fund2/Médio'},
    {start:'11:00',label:'11:00–11:45 • Infantil/Fund1'},
    {start:'11:30',label:'11:30–12:15 • Fund2/Médio'},
    {start:'11:45',label:'11:45–12:30 • Infantil/Fund1'},
    {start:'12:15',label:'12:15–13:00 • Fund2/Médio'},
    {start:'12:30',label:'12:30–13:15 • Infantil/Fund1'}
  ];
  const AFTERNOON_COMBINED=[
    {start:'13:30',label:'13:30–14:15 • Todos'},
    {start:'14:15',label:'14:15–15:00 • Todos'},
    {start:'15:00',label:'15:00–15:45 • Todos'},
    {intervalo:true,label:'INTERVALO'},
    {start:'16:15',label:'16:15–17:00 • Todos'},
    {start:'17:00',label:'17:00–17:45 • Todos'}
  ];

  // estado
  let reservations=[];
  let totals={ tablets_internet:25, tablets_geral:222, notebooks:150, lab_tec:1, sala_maker:1 };
  const today=new Date();
  let weekStart=startOfWeek(today);

  // DOM
  const calMorning=document.getElementById('calMorning');
  const calAfternoon=document.getElementById('calAfternoon');
  const btnNew=document.getElementById('btnNew');
  const btnExport=document.getElementById('btnExport');
  const importFile=document.getElementById('importFile');
  const totTI=document.getElementById('totTI');
  const totTG=document.getElementById('totTG');
  const totN=document.getElementById('totN');
  const totLT=document.getElementById('totLT');
  const totSM=document.getElementById('totSM');

  const prevWeek=document.getElementById('prevWeek');
  const nextWeek=document.getElementById('nextWeek');
  const thisWeek=document.getElementById('thisWeek');
  const datePicker=document.getElementById('datePicker');

  // admin
  const adminPassInput=document.getElementById('adminPass');
  const btnAdmin=document.getElementById('btnAdmin');
  const adminStatus=document.getElementById('adminStatus');
  let adminOn=false, adminPassVal='';

  // modal
  window.dlg=document.getElementById('dlg');
  const frm=document.getElementById('frm');
  const fDay=document.getElementById('fDay');
  const fPeriod=document.getElementById('fPeriod');
  const fSegment=document.getElementById('fSegment');
  const fStart=document.getElementById('fStart');
  const fSpan=document.getElementById('fSpan');
  const fResource=document.getElementById('fResource');
  const fQty=document.getElementById('fQty');
  const fTeacher=document.getElementById('fTeacher');
  const fClass=document.getElementById('fClass');
  const fNotes=document.getElementById('fNotes');
  const conflictMsg=document.getElementById('conflictMsg');

  // init
  datePicker.value=toYmd(today);
  fillFormDays();
  refreshAll();
  setInterval(refreshAll, REFRESH_MS);
  updateAdminUI();

  // eventos
  btnNew.addEventListener('click', ()=>{ resetForm(); dlg.showModal(); });

  prevWeek.addEventListener('click', ()=>{ weekStart=addDays(weekStart,-7); fillFormDays(); renderCalendars(); });
  nextWeek.addEventListener('click', ()=>{ weekStart=addDays(weekStart, 7); fillFormDays(); renderCalendars(); });
  thisWeek.addEventListener('click', ()=>{ weekStart=startOfWeek(new Date()); datePicker.value=toYmd(new Date()); fillFormDays(); renderCalendars(); });
  datePicker.addEventListener('change', e=>{ const d=new Date(e.target.value+'T00:00'); if(!isNaN(d)){ weekStart=startOfWeek(d); fillFormDays(); renderCalendars(); } });

  function lockQtyIfRoom(){
    const r=fResource.value;
    const isRoom=(r==='lab_tec'||r==='sala_maker');
    fQty.value=isRoom?1:Math.max(1, +fQty.value||1);
    fQty.min = 1;
    fQty.max = isRoom ? 1 : 9999;
    fQty.readOnly = isRoom;
  }
  fResource.addEventListener('change', lockQtyIfRoom);

  function populateStartsAndKeep(){
    const prev=fStart.value; populateStarts();
    if ([...fStart.options].some(o=>o.value===prev)) fStart.value=prev;
  }
  fPeriod.addEventListener('change', populateStartsAndKeep);
  fSegment.addEventListener('change', populateStartsAndKeep);

  btnExport.addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify({totals,reservations},null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='reservas.json'; a.click(); URL.revokeObjectURL(url);
  });

  importFile.addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{ const text=await f.text(); const data=JSON.parse(text); await api('import',{data}); await refreshAll(); alert('Importado!'); }
    catch{ alert('Arquivo inválido.'); }
    e.target.value='';
  });

  // ✅ handler do botão Admin com verificação de senha
  btnAdmin.addEventListener('click', ()=>{
    if(!adminOn){
      const v=(adminPassInput.value||'').trim();
      if (v !== ADMIN_PASSWORD) {
        alert('Senha incorreta.');
        adminOn=false; adminPassVal='';
        updateAdminUI();
        return;
      }
      // senha OK
      adminPassVal=v; adminOn=true;
    }else{
      // desligar
      adminOn=false; adminPassVal=''; adminPassInput.value='';
    }
    updateAdminUI(); renderCalendars();
  });

  frm.addEventListener('submit', async e=>{
    e.preventDefault();
    const dayIdx=parseInt(fDay.value,10);
    const period=fPeriod.value;
    const segment=fSegment.value;
    const resource=fResource.value;
    const span=clampInt(fSpan.value,1,6);

    let qty=clampInt(fQty.value,1,9999);
    if (resource==='lab_tec' || resource==='sala_maker') qty=1;

    const teacher=fTeacher.value.trim();
    const turma=fClass.value.trim();
    const notes=fNotes.value.trim();

    const dayDate=addDays(weekStart,dayIdx);
    const starts=getStartsFor(period,segment);
    const i=starts.indexOf(fStart.value);
    if(i===-1){ alert('Início inválido.'); return; }

    const slots=[]; for(let k=0;k<span;k++){ const s=starts[i+k]; if(!s) break; slots.push({start:s,end:add45(s)}); }

    const conflicts=checkConflicts(dayDate, slots, resource, qty);
    if(conflicts.length){
      conflictMsg.innerHTML='<b>Conflito:</b><br>'+conflicts.map(c=>`• ${c.time} (faltam ${c.lack})`).join('<br>');
      return;
    }

    await api('save',{ rec:{
      date:toYmd(dayDate), period, segment, resource, qty, teacher, turma, notes, slots
    }});
    dlg.close(); conflictMsg.textContent=''; await refreshAll();
  });

  // render
  function renderCalendars(){
    totTI.textContent = totals.tablets_internet;
    totTG.textContent = totals.tablets_geral;
    totN.textContent  = totals.notebooks;
    totLT.textContent = totals.lab_tec;
    totSM.textContent = totals.sala_maker;

    renderCalendar(calMorning, MORNING_COMBINED, 'manha');
    renderCalendar(calAfternoon, AFTERNOON_COMBINED, 'tarde');
  }

  function renderCalendar(container, rows, period){
    const days=getWeekDays(weekStart);
    const table=document.createElement('table'); table.className='calendar';
    const thead=document.createElement('thead'); const trh=document.createElement('tr');
    trh.innerHTML='<th class="time-col">Horário</th>'+days.map(d=>`<th>${weekdayName(d)}<div class="small">${toBr(d)}</div></th>`).join('');
    thead.appendChild(trh); table.appendChild(thead);

    const tbody=document.createElement('tbody');
    rows.forEach(row=>{
      const tr=document.createElement('tr');
      const tdTime=document.createElement('td'); tdTime.className='time-col';
      if(row.intervalo){
        tdTime.innerHTML=`<div class="slot-label">${row.label}</div>`;
        tr.appendChild(tdTime);
        for(let i=0;i<5;i++){ const td=document.createElement('td'); td.className='intervalo'; tr.appendChild(td); }
        tbody.appendChild(tr); return;
      }
      tdTime.innerHTML=`<div class="slot-label">${row.label}</div>`;
      tr.appendChild(tdTime);

      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        const d=addDays(weekStart,c); const ymd=toYmd(d);

        const starters=reservations.filter(r=> r.date===ymd && r.period===period && r.slots.some(s=>s.start===row.start));
        starters.forEach(r=>{
          const div=document.createElement('div'); div.className='reservation';
          const label = resLabel(r.resource);
          div.innerHTML = `<span class="qty">${r.qty}×</span> <span>${label}</span> · <span>${esc(r.turma)}</span> · <span class="meta">${esc(r.teacher)}</span>`+(r.notes?` · <span class="meta">${esc(r.notes)}</span>`:'')+` <span class="del" title="Remover">🗑</span>`;
          const del=div.querySelector('.del');
          del.addEventListener('click', async (ev)=>{
            ev.stopPropagation();
            if(!adminOn) return;
            if(!confirm('Excluir esta reserva?')) return;
            try{ await api('delete',{id:r.id,admin:adminPassVal}); await refreshAll(); }
            catch(e){ alert('Erro ao excluir.'); }
          });
          td.appendChild(div);
        });

        const av=availabilityAt(d,row.start);
        const p=document.createElement('div'); p.className='small';
        p.textContent=`Disp.: ${av.ipads_internet}📱Int / ${av.ipads_geral}📱Ger / ${av.notebooks}💻 / ${av.lab_tec}🧪 / ${av.sala_maker}🛠️`;
        td.appendChild(p);

        td.addEventListener('click', ()=>{
          resetForm(); fDay.value=String(c); fPeriod.value=period; populateStarts(); fStart.value=row.start; dlg.showModal();
        });

        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.innerHTML=''; container.appendChild(table);
    container.classList.toggle('admin-on', adminOn);
  }

  // disponibilidade / conflitos (sem dupla contagem)
  function availabilityAt(dateObj,startHHMM){
    const ymd=toYmd(dateObj); const s0=toMin(startHHMM), e0=s0+45;
    const used={ ipads_internet:0, ipads_geral:0, notebooks:0, lab_tec:0, sala_maker:0 };

    reservations.forEach(r=>{
      if(r.date!==ymd) return;
      const overlaps = r.slots && r.slots.some(s=> Math.max(s0, toMin(s.start)) < Math.min(e0, toMin(s.end)));
      if(overlaps){ used[r.resource] = (used[r.resource]||0) + r.qty; }
    });

    return {
      ipads_internet: Math.max(0, (totals.tablets_internet||0) - (used.ipads_internet||0)),
      ipads_geral:    Math.max(0, (totals.tablets_geral||0)    - (used.ipads_geral||0)),
      notebooks:      Math.max(0, (totals.notebooks||0)        - (used.notebooks||0)),
      lab_tec:        Math.max(0, (totals.lab_tec||0)          - (used.lab_tec||0)),
      sala_maker:     Math.max(0, (totals.sala_maker||0)       - (used.sala_maker||0)),
    };
  }

  function checkConflicts(dayDate, slots, resource, qty){
    const ymd=toYmd(dayDate); const cap = capFor(resource);
    const conflicts=[];
    slots.forEach(ns=>{
      const s0=toMin(ns.start), e0=s0+45; let used=0;
      reservations.forEach(r=>{
        if(r.date!==ymd || r.resource!==resource) return;
        const overlaps = r.slots && r.slots.some(s=> Math.max(s0, toMin(s.start)) < Math.min(e0, toMin(s.end)));
        if(overlaps) used += r.qty;
      });
      const left = cap - used;
      if(qty>left) conflicts.push({ time:`${ns.start}–${ns.end}`, lack: qty-left });
    });
    return conflicts;
  }

  // helpers
  function capFor(res){
    if(res==='ipads_internet') return totals.tablets_internet||0;
    if(res==='ipads_geral')    return totals.tablets_geral||0;
    if(res==='notebooks')      return totals.notebooks||0;
    if(res==='lab_tec')        return totals.lab_tec||0;
    if(res==='sala_maker')     return totals.sala_maker||0;
    return 0;
  }
  function resLabel(res){
    return res==='ipads_internet'?'📱 iPads Internet'
        : res==='ipads_geral'   ?'📱 iPads Geral'
        : res==='notebooks'     ?'💻 Notebooks'
        : res==='lab_tec'       ?'🧪 Lab Tec'
        : res==='sala_maker'    ?'🛠️ Sala Maker'
        : res;
  }

  async function api(action,payload={}){
    const body='data='+encodeURIComponent(JSON.stringify({action,...payload}));
    const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
    const text=await res.text(); let json;
    try{ json=JSON.parse(text);}catch(e){ showErr('Resposta inválida do servidor'); throw e; }
    if(!json.ok){ showErr(json.error||'Erro API'); throw new Error(json.error||'Erro'); }
    return json;
  }

  async function refreshAll(){ const t=await api('getTotals'); totals=t.totals||totals; const l=await api('list'); reservations=l.items||[]; renderCalendars(); }
  function populateStarts(){ const list=getStartsFor(fPeriod.value,fSegment.value); fStart.innerHTML=list.map(t=>`<option value="${t}">${t} – ${add45(t)}</option>`).join(''); lockQtyIfRoom(); }
  function getStartsFor(period,segment){ if(period==='tarde') return AFTERNOON_ALL.slice(); if(segment==='Infantil'||segment==='Fundamental 1') return MORNING_IF1.slice(); if(segment==='Fundamental 2'||segment==='Ensino Médio') return MORNING_F2M.slice(); return []; }
  function resetForm(){ conflictMsg.textContent=''; fDay.value='0'; fPeriod.value='manha'; fSegment.value='Infantil'; populateStarts(); fStart.value=getStartsFor('manha','Infantil')[0]; fSpan.value=1; fResource.value='ipads_geral'; fQty.value=10; lockQtyIfRoom(); fTeacher.value=''; fClass.value=''; fNotes.value=''; }
  function fillFormDays(){ const days=getWeekDays(weekStart); fDay.innerHTML=days.map((d,i)=>`<option value="${i}">${weekdayName(d)} - ${toBr(d)}</option>`).join(''); }

  function startOfWeek(d){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=x.getDay(); const diff=(day===0?-6:1-day); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function getWeekDays(start){ return [0,1,2,3,4].map(i=>addDays(start,i)); }
  function toBr(d){ return d.toLocaleDateString('pt-BR'); }
  function toYmd(d){ const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2); return `${y}-${m}-${da}`; }
  function weekdayName(d){ const names=['Seg','Ter','Qua','Qui','Sex','Sáb','Dom']; const idx=(d.getDay()+6)%7; return names[idx]; }
  function toMin(hm){ const [h,m]=hm.split(':').map(Number); return h*60+m; }
  function fromMin(min){ const h=Math.floor(min/60), m=min%60; return `${('0'+h).slice(-2)}:${('0'+m).slice(-2)}`; }
  function add45(hm){ return fromMin(toMin(hm)+45); }
  function clampInt(v,min,max){ v=parseInt(v,10); if(isNaN(v)) v=min; return Math.max(min,Math.min(max,v)); }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  function updateAdminUI(){
    if(adminStatus) adminStatus.textContent='Modo admin: '+(adminOn?'ligado':'desligado');
    document.querySelectorAll('.calendar').forEach(el=>el.classList.toggle('admin-on', adminOn));
  }
})();
</script>
